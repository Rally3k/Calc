<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Rally 3k web - History</title>

    <!-- Bootstrap -->
    <link href="files/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="files/font-awesome/css/font-awesome.min.css">

    <script src="https://api-maps.yandex.ru/2.1/?load=package.full&lang=ru-RU" type="text/javascript"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
    </style>
</head>

<body>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="files/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="files/bootstrap.min.js"></script>
    <script type="text/ecmascript" src="files/NoSleep.min.js"></script>

    <div class="form-group">
    <form class="form-inline">
        <label for="selectRds">РДС:</label>
        <select class="form-control" id="selectRds">
            <option>1</option>
            <option>2</option>
            <option>3</option>
            <option>4</option>
        </select>
    </form>
    <div class="content grid container-fluid">
    </div>
        <div class="row">
            <div class=" col-xs-6">
                <table id="rdsTable" class="table">
                    <thead>
                        <tr>
                            <th>Тип</th>
                            <th>Дистанция</th>
                            <th>Скорость</th>
                            <th>Опоздание</th>
                            <th>Норма</th>
                            <th>Время</th>
                            <th>Координаты</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#selectRds').change(function() {
                var rds = JSON.parse(localStorage.getItem("rds" + $('#selectRds').val()));
                $("#rdsTable > tbody tr").remove();
                if (rds) {
                    for (var i = 0; i < rds.length; ++i) {
                        //rds.push(new RdsItem(ris[i]));
                        var t = '';
                        switch (rds[i].type) {
                            case 'S':
                                t = '<i class="fa fa-play rdsIcon"></i>';
                                break;
                            case 'C':
                                t = '<i class="fa fa-tachometer rdsIcon"></i>';
                                break;
                            case 'P':
                                t = '<i class="fa fa-flag-checkered rdsIcon"></i>';
                                break;
                            case 'F':
                                t = '<i class="fa fa-stop rdsIcon"></i>';
                                break;
                        }
                        $('#rdsTable > tbody').append($('<tr>')
                            .append($('<td>').html(t))
                            .append($('<td>').text(getNumberString(rds[i].distance, 1000)))
                            .append($('<td>').text(getNumberString(rds[i].speed, 100)))
                            .append($('<td>').text(getNumberString(rds[i].lateness, 10)))
                            .append($('<td>').text(getTimeString(rds[i].norm, true)))
                            .append($('<td>').text(getTimeString(rds[i].time, true)))
                            .append($('<td>').html('<a href="https://maps.yandex.ru/?text=' + rds[i].latitude + ', ' + rds[i].longitude + '">' + rds[i].latitude + ' ' + rds[i].longitude + '</a>'))
                        );
                    }
                }
            });

            $('#selectRds > option').remove();
            for (var i = 0; i < 100; ++i) {
                if (localStorage.getItem("rds" + i)) {
                    $('#selectRds').prepend($('<option>', { value: i, text: "РДС " + i}));
                }
            }
        });

        function RdsItem(distance, type, speed, time, latitude, longitude) {
            if (type === undefined && typeof(distance) === 'object') {
                for (var prop in distance) {
                    this[prop] = distance[prop];
                }
            } else {
                this.type = type;
                this.distance = distance;
                this.speed = speed;
                this.time = time;
                this.latitude = latitude;
                this.longitude = longitude;
                this.vPdd = currentPddSpeed;
                this.vPddLateness = 0;
                this.vPddNorm = 0;
                this.lateness = 0;
                this.norm = 0;
            }
        }

        function getTimeString(value, seconds) {
            if (value == null) {
                return "--:--:--";
            }
            var n = value < 0;
            value = Math.abs(value);
            var h = Math.floor(value / 3600);
            var m = Math.floor((value - 3600 * h) / 60);
            if (seconds) {
                var s = Math.floor(value - 60 * m - 3600 * h);
                return (n ? "-" : "") + h + (m < 10 ? ":0" : ":") + m + (s < 10 ? ":0" : ":") + s;
            } else {
                return (n ? "-" : "") + h + (m < 10 ? ":0" : ":") + m;
            }
        }

        function getNumberString(value, size) {
            if (value == null) {
                return "--.--"
            }
            var n = value < 0;
            value = Math.abs(value);
            if (size < 1) {
                return (n ? "-" : "") + Math.floor(value * size) / size;
            }
            var s = Math.round(value * size) / size + '';
            var dp = 1.1 + '';
            dp = dp.toLocaleString().substring(1, 2);
            var d = s.indexOf(dp);
            if (d == -1) {
                d = size;
                s = s + dp;
            } else {
                d = size / Math.pow(10, s.length - d - 1);
            }
            for (; d > 1; d = d / 10) {
                s = s + '0';
            }
            return (n ? "-" : "") + s;
        }

    </script>
</body>
</html>
